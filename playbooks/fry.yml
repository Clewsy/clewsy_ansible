---
- name: Configure fry.
  hosts: fry
  become: yes
  gather_facts: false

  handlers:
    - import_tasks: handlers/handlers.yml

  roles:
    - common
    - secure
    - headless
    - node
    - sshuttle

  # Run tasks specific only to fry.
  tasks:

    - name: Clone repos to home directory.
      git:
        repo: "{{ repo_root }}/{{ item }}"
        dest: "{{ ansible_user_home_dir }}/{{ item }}"
        accept_hostkey: yes
        key_file: "{{ ansible_user_home_dir }}/.ssh/id_rsa" #Use key and ssh to clone private repo/s.
        ssh_opts: "-o StrictHostKeyChecking=no"
      with_items: "{{ repos }}"
      register: repo_clones
    
    - name: "Ensure cloned repos are owned by {{ ansible_user }}{{ ':' }}{{ ansible_user }}"
      file:
        recurse: yes
        path: "{{ ansible_user_home_dir }}/{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      with_items: "{{ repos }}"
      when: repo_clones is changed

  vars:
    repo_root: "git@gitlab.com:clewsy"
    repos:
      - scripts
      - misc
      - docs

