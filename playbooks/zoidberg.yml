#Set up zoidberg web host services.  Assumes ubuntu installed and configures sudo user jc.

- name: Configure zoidberg.
  hosts: zoidberg
  become: yes
  vars:
    packages:
      - docker
      - docker-compose

  tasks:

    - name: Install packages.
      apt:
        name: "{{ packages }}"
        state: latest
        update_cache: yes

    - name: Sync user profile.
      copy:
        src: ../zoidberg/home/jc
        dest: /home/

    - name: Add user to docker group.
      user:
        name: jc
        groups: docker

    - name: Run dockerd (for first install, will run automatically after reboot).
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create docker-compose staging area.
      file:
        path: /home/docker
        state: directory
        owner: jc
        group: jc
        mode: u=rwx,g=rx,o=rx

    - name: Sync clews.pro repo ready for use by docker-compose.
      git:
        repo: git@gitlab.com:clewsy/clews.pro.git
        dest: /home/docker
        key_file: /home/jc/.ssh/id_rsa

    - name: Pull docker container images listed in docker.compose.yml.
      command:
        chdir: /home/docker/
        cmd: docker-compose pull

    - name: Run docker-compose.
      command: 
        chdir: /home/docker/
        cmd: docker-compose up -d

