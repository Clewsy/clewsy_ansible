---
- name: Sync data from backup if it doesn't exist on host (pull to destination).
  synchronize:
    set_remote_user: no #Use .ssh/config to define user.  Remember, rsync command will be run as root on delegate.
    mode: push  #I.e. localhost or delegate is source.
    rsync_opts: "--update"
    src: "{{ clews_docker_backup_dir }}"  ##Location of docker dir.
    dest: /home/  ##Where to put docker dir.
  delegate_to: "{{ clews_docker_backup_host }}"

- name: Sync clews.pro repo ready for use by docker-compose.
  git:
    repo: "{{ clews_repo }}"
    dest: /home/docker
    accept_hostkey: yes
    key_file: "/home/{{ ansible_user }}/.ssh/id_rsa"

- name: Pull docker container images listed in docker.compose.yml.
  command:
    chdir: /home/docker/
    cmd: docker-compose pull

- name: Kill openvpn if it is running (will otherwise interfere with running web services).
  command: pkill openvpn #Returns 1 if openvpn not running.
  register: command_result
  failed_when: command_result.rc > 1

- name: Create clews.service unit file.
  get_url:
    url: "{{ clews_unit_file }}"
    dest: /etc/systemd/system/clews.service
    mode: 0644
    owner: root
    group: root

- name: Enable clews.service.
  service:
    name: clews
    enabled: yes

- name: Start clews.service (will spin up containers if not already up).
  service:
    name: clews
    state: started

