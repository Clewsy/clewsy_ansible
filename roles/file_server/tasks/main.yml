---
- name: Ensure all packages required for file_server are installed.
  apt:
    name: "{{ file_server_packages }}"
    state: latest
  notify: Restart nfs server.


#/etc/exports from zapp openmediaserver
## This file is auto-generated by openmediavault (https://www.openmediavault.org)
## WARNING: Do not edit this file, your changes will get lost.
#
## /etc/exports: the access control list for filesystems which may be exported
##               to NFS clients.  See exports(5).
#/export/cl0ud 192.168.1.0/24(fsid=1,rw,rw,subtree_check,insecure,no_root_squash)
#/export/data 192.168.1.0/24(fsid=2,rw,rw,subtree_check,insecure,no_root_squash)
#/export/m0n0l1th 192.168.1.0/24(fsid=3,rw,rw,subtree_check,insecure,no_root_squash)
#/export/movies 192.168.1.0/24(fsid=4,rw,rw,subtree_check,insecure,no_root_squash)
#/export/mp3s 192.168.1.0/24(fsid=5,rw,rw,subtree_check,insecure,no_root_squash)
#/export/music_videos 192.168.1.0/24(fsid=6,rw,rw,subtree_check,insecure,no_root_squash)
#/export/tv 192.168.1.0/24(fsid=7,rw,rw,subtree_check,insecure,no_root_squash)
#
## NFSv4 - pseudo filesystem root
#/export 192.168.1.0/24(ro,fsid=0,root_squash,no_subtree_check,hide)



#pre-work - new disks: - create partition/s ext4 and identify partition uuid /dev/disk/by-partuuid

#mount disk
###/dev/disk/by-label/m0n0l1th		/srv/dev-disk-by-label-m0n0l1th	ext4	defaults,nofail,user_xattr,noexec,usrjquota=aquota.user,grpjquota=aquota.group,jqfmt=vfsv0,acl	0 2
###/srv/dev-disk-by-label-m0n0l1th/		/export/m0n0l1th	none	bind,nofail	0 0
###
###/dev/disk/by-label/m0n0l1th		/export/m0n0l1th	ext4	defaults,nofail,user_xattr,noexec,usrjquota=aquota.user,grpjquota=aquota.group,jqfmt=vfsv0,acl	0 2
###
###/dev/disk/by-label/m0n0l1th		/export/m0n0l1th	ext4	auto,noexec,rw,async,user,nofail	0 0





- name: Label the partitions (with e2label).
  shell: "/usr/sbin/e2label /dev/disk/by-uuid/{{ item.uuid }} {{ item.label }}"
  with_items: "{{ nfs_server_disks }}"

- name: Mount the disks to /srv.
  mount:
    src: "LABEL={{ item.label }}"
    path: "/srv/{{ item.label }}"
    fstype: auto
    opts: 'auto,noexec,rw,async,user,nofail'
    state: mounted
  with_items: "{{ nfs_server_disks }}"

- name: Mount (bind) nfs shares to /export.
  mount:
    src: "{{ item.source_path }}"
    path: "{{ item.share_path }}"
    fstype: auto
    opts: 'bind,auto,noexec,rw,async,user,nofail'
    state: mounted
  with_items: "{{ nfs_server_shares }}"
#- name: Mount the partition to /export/...
#  mount:
#    src: LABEL=m0n0l1th
#    path: /export/m0n0l1th
#    fstype: ext4
#    opts: 'auto,noexec,rw,async,user,nofail'
#    state: mounted
#  notify: Restart nfs server

##configure nfs server
#
#- name: Create mountable directory.
#  file:
#    path: /export/m0n0l1th
#    state: directory
#    mode: '0777'
#    owner: root
#    group: root
#
#
#- name: Update /etc/exports.
#  lineinfile:
#    path: /etc/exports
#    regexp: "m0n0l1th"
#    line: "/export/m0n0l1th 192.168.1.0/24(rw,sync,no_root_squash,no_subtree_check)"
#  notify: Start nfs server.

