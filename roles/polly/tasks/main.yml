---
- name: Ensure scripts library directory exists ({{ scripts_lib }}).
  file:
    dest: "{{ scripts_lib }}"
    state: directory
    owner: 'root'
    group: 'root'
    mode: '0755'

- name: Copy polly.sh script to script library.'
  get_url:
    url: "{{ polly_script_url }}"
    dest: "{{ scripts_lib }}/polly.sh"
    force: yes
    owner: 'root'
    group: 'root'
    mode: '0644'
  register: polly

- name: Ensure bin directory exists within user's home directory.
  file:
    dest: "{{ ansible_user_home_dir }}/bin"
    mode: 0755
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
  when: polly is changed

- name: Copy polly.sh script for use by {{ ansible_user }}.
  copy:
    src: "{{ scripts_lib }}/polly.sh"
    dest: "{{ polly_script_dest_user }}"
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: 0755
  when: polly is changed

- name: Copy polly.sh script for root use.
  copy:
    src: "{{ scripts_lib }}/polly.sh"
    dest: "{{ polly_script_dest_root }}"
    remote_src: yes
    owner: "root"
    group: "root"
    mode: 0755
  when: polly is changed

- name: Install and enable blink1-tool.
  include: blink1_tool.yml

- name: Create cronjob for polly.sh poll jobs.
  cron:
    name: "Role: \"polly\" - Run polly.sh."
    minute: "*/5"
    user: "{{ ansible_user }}"
    job: "sudo {{ polly_script_dest_root }}"
  notify: Restart cron.
