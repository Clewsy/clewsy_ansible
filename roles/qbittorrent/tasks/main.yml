---
- name: Copy docker-compose.yml file to {{ qbittorrent_home_dir }} ready for use by docker-compose.
  copy:
    src: files/docker-compose.yml
    dest: "{{ qbittorrent_docker_compose_yml }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Pull docker container images listed in docker-compose.yml.
  docker_compose:
    project_src: "{{ qbittorrent_home_dir }}"
    pull: yes
    recreate: smart #Containers will be recreated if a new version is pulled.

- name: Create a symlink to the downloads directory within the user's home directory.
  file:
    src: "{{ qbittorrent_home_dir }}/qbittorrent/downloads"
    dest: "{{ ansible_user_home_dir }}/downloads"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link

- name: "Create cron job to pull and update to the latest qbittorrent container image daily."
  cron:
    name: 'Role: "qbittorrent" - Pull and run the latest container image for qbittorrent.'
    minute: "{{ qbittorrent_cron.minute }}"
    hour: "{{ qbittorrent_cron.hour }}"
    day: "{{ qbittorrent_cron.day }}"
    month: "{{ qbittorrent_cron.month }}"
    weekday: "{{ qbittorrent_cron.weekday }}"
    user: "{{ ansible_user }}"
    job: '/usr/bin/docker-compose -f {{ qbittorrent_docker_compose_yml }} pull && /usr/bin/docker-compose -f {{ qbittorrent_docker_compose_yml }} up -d'
